#!/bin/bash
echo "Starting post-commit hook..."

MESSAGE=$(git log -1 HEAD --pretty=format:%s)

# Push current commit to remote repository
git push

if [[ $? -eq 0 ]]; then
  echo "Push was successful."

  CHANGED_FILES=$(git diff-tree --no-commit-id --name-only -r HEAD)

  # Loop through the list of changed files and apply MISRAivoso.py to each one
  for FILE in $CHANGED_FILES; do
    python3 utils/misraivoso/MISRAivoso.py --correction --src air/ --src-file "$FILE"
  done

  python3 utils/misraivoso/MISRAivoso.py --correction --src air/ --src-file-list air/pmk # [--include-comments] [--delete-comments]
  python3 utils/misraivoso/MISRAivoso.py --correction --src air/ --src-file-list air/libs
  python3 utils/misraivoso/MISRAivoso.py --correction --src air/ --src-file-list air/pos/bare
  python3 utils/misraivoso/MISRAivoso.py --correction --src air/ --src-file-list air/tools
  git add .
  git commit -m "$MESSAGE (MISRA)"
  git push

else
  echo "Push failed, please check your connection."
  git reset --soft HEAD~1

fi

echo "Terminating post-commit hook..."