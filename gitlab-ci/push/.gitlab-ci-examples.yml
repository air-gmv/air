# Gitlab CICD script for example stage
# Author huca@GMV 2023

.build-executable: &build-executable
    - $AIR/configure
    - make clean
    - make
    - if ! test -f ./executable/AIRAPP.exe; then echo "Executable doens\'t exist." && exit 1; fi

.check-and-publish: &check-and-publish
#    - $AIR/../utils/gitlab-runner/testcheck.py
    - $UTILS/publish_example.bash

# ARM 
.ARM-QEMU-example-template:
    stage: examples
    tags:  ["ARM"]
    variables:
        GIT_STRATEGY: fetch
    script:
        - export STATE_FOLDER=$HOME/state/$CI_COMMIT_SHA

        - if ! test -d $STATE_FOLDER; 
            then 
                (mkdir -p $STATE_FOLDER || true) && ./utils/gitlab-runner/check_central_server.bash; 
            else 
                ./utils/gitlab-runner/check_central_server.bash;
            fi;

        - cd $STATE_FOLDER
        - cd air
        
        - export AIR=$STATE_FOLDER/air/
        - export PATH=$PATH:$AIR
        - export AIR_INSTALL=$AIR/install
        - export AIR_PMK=$AIR_INSTALL/pmk
        - export AIR_POS=$AIR_INSTALL/pos

        - export RTEMS410=/opt/rtems-4.10/bin
        - export PATH=$PATH:$RTEMS410
        - export RTEMS_MAKEFILE_PATH=$AIR_POS/rtems5/rtems5-install/sparc-rtems5/gr740
        - export PATH=$PATH:/opt/gcc-arm-9.2-2019.12-x86_64-arm-none-eabi/bin

        - export DISPLAY=:99
        - export PATH=/opt/rtems/5/bin:$PATH
        - export PATH=/opt/rtems-5.1-2019.07.25/bin:$PATH
        - export PATH=/opt/laysim-gr740:$PATH

        - export UTILS=$AIR/../utils/gitlab-runner

        - cd $AIR/examples/$EXAMPLE
        - *build-executable
        - ($UTILS/rvs_arm_coverage-ci.bash | tee testresult.txt) || true 
        - make distclean
        - *check-and-publish
    rules:
        - if: '$CI_COMMIT_MESSAGE =~ /^\[(ALL|ARM)\]/ && $CI_JOB_NAME =~ /(hello\_world|bare\_c)$/'
        - if: '$CI_COMMIT_MESSAGE !~ /.*\[.*?\].*/ && $CI_JOB_NAME =~ /(hello\_world|bare\_c)$/'

ARM-QEMU-hello_world:
    extends: .ARM-QEMU-example-template
    variables: 
        EXAMPLE: "hello_world"

ARM-QEMU-bare_c:
    extends: .ARM-QEMU-example-template
    variables: 
        EXAMPLE: "bare_c"

# SPARC
.SPARC-LAYSIM-example-template:
    stage: examples
    tags:  ["SPARC","LAYSIM"]
    script:
        - cd $AIR/examples/$EXAMPLE
        - *build-executable
        - laysim-gr740-mmu-cli -batch ../../rvs_air/scripts/laysim_cmds.txt | tee testresult.txt
        - make distclean
        - *check-and-publish
    rules:
        - if: '$CI_COMMIT_MESSAGE =~ /^\[(ALL|SPARC)\]/ && $CI_JOB_NAME =~ /(hello\_world|bare\_c)$/'

SPARC-LAYSIM-hello_world:
    extends: .SPARC-LAYSIM-example-template
    variables: 
        EXAMPLE: "hello_world"

SPARC-LAYSIM-bare_c:
    extends: .SPARC-LAYSIM-example-template
    variables: 
        EXAMPLE: "bare_c"
    
SPARC-LAYSIM-hm:
    extends: .SPARC-LAYSIM-example-template
    variables: 
        EXAMPLE: "hm"

SPARC-LAYSIM-ports:
    extends: .SPARC-LAYSIM-example-template
    variables: 
        EXAMPLE: "ports"

SPARC-LAYSIM-shm:
    extends: .SPARC-LAYSIM-example-template
    variables: 
        EXAMPLE: "shm"

SPARC-LAYSIM-paranoia:
    extends: .SPARC-LAYSIM-example-template
    variables: 
        EXAMPLE: "paranoia"
    script:
        - cd $AIR/examples/testsuites/$EXAMPLE
        - *build-executable
        - laysim-gr740-mmu-cli -batch $AIR/rvs_air/scripts/laysim_cmds.txt | tee testresult.txt
        - *check-and-publish

SPARC-LAYSIM-smp01:
    extends: .SPARC-LAYSIM-example-template
    variables: 
        EXAMPLE: "smp01"
    script:
        - cd $AIR/examples/testsuites/$EXAMPLE
        - *build-executable
        - laysim-gr740-mmu-cli -batch $AIR/rvs_air/scripts/laysim_cmds.txt | tee testresult.txt
        - *check-and-publish

SPARC-LAYSIM-smp02:
    extends: .SPARC-LAYSIM-example-template
    variables: 
        EXAMPLE: "smp02"
    script:
        - cd $AIR/examples/testsuites/$EXAMPLE
        - *build-executable
        - laysim-gr740-mmu-cli -batch $AIR/rvs_air/scripts/laysim_cmds.txt | tee testresult.txt
        - *check-and-publish

# laysim-math:
#    extends: .SPARC-LAYSIM-example-template
#    variables: 
#        EXAMPLE: "math"
