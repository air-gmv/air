# Gitlab CICD script for build stage
# Author huca@GMV 2023

# Build ARM ZYNQZ1
ARM-ZYNQZ1-build:
    stage: prepare-build
    tags: ["ARM1"]
    needs: ["ARM1_init", "enable_display1"]
    script:
        - cp $UTILS/.arm_zynqz1_config .
        - ./configure -f .arm_zynqz1_config
        #- make pmk
        #- make libs
        #- make pos
        #- make tools
        - make clean
        - make -j4
    rules:
        - if: '$CI_COMMIT_MESSAGE =~ /^\[(ALL|ARM)\]/' # message starts with [ALL] or [ARM] 
        - if: '$CI_COMMIT_MESSAGE !~ /.*\[.*?\].*/'

# Build SPARC GR740 
SPARC-GR740-build:
    stage: prepare-build
    tags: ["sparc-taste-debian1"]
    needs: ["TASTE1_init", "enable_display1"]
    script:
        - cp $UTILS/.sparc_gr740_config .
        - ./configure -f .sparc_gr740_config
        - make pmk
        - make libs
        - make pos
        - make tools
    rules:
        - if: '$CI_COMMIT_MESSAGE =~ /^\[(ALL|SPARC)\]/' # message starts with [ALL] or [SPARC]

generate-test-yml:
    stage: prepare-build
    script:
        - export TEST_NUMBER=$(echo $CI_COMMIT_MESSAGE | sed -nE 's/.*([0-9]{5}).*/\1/p')
        - ./../gitlab-ci/push/generate-test.sh $TEST_NUMBER
        - mv test.yml $CI_PROJECT_DIR
    artifacts:
        paths:
            - $CI_PROJECT_DIR/test.yml
    rules:
        - if: '$CI_COMMIT_MESSAGE =~ /^\[(ARM|SPARC)\]/ && $CI_COMMIT_MESSAGE =~ /\(\d{5}\)/'
        - if: '$CI_COMMIT_MESSAGE !~ /.*\[.*?\].*/ && $CI_COMMIT_MESSAGE =~ /\(\d{5}\)/'


# Build SPARC LEON4 
.SPARC-LEON4-build:
    stage: prepare-build
    tags: ["sparc-taste-debian1"]
    needs: ["TASTE1_init"]
    script:
        - cp $UTILS/.sparc_leon4_config .
        - ./configure -f .sparc_leon4_config
        #- make pmk
        #- make libs
        #- make pos
        #- make tools
        - make clean
        - make -j4

    rules:
        - if: '$CI_COMMIT_MESSAGE =~ /^\[(ALL|SPARC)\]/' # message starts with [ALL] or [SPARC]

# Build SPARC LEON3
.SPARC-LEON3-build:
    stage: prepare-build
    tags: ["OTHER"]
    script:
        - cp $UTILS/.sparc_leon3_config .
        - ./configure -f .sparc_leon3_config
        - make clean
        - make -j4
    rules:
        - if: '$CI_COMMIT_MESSAGE =~ /^\[(ALL|SPARC)\]/' # message starts with [ALL] or [SPARC]

# Build SPARC TSIM 
.SPARC-TSIM-build:
    stage: prepare-build
    tags: ["OTHER"]
    script:
        - cp $UTILS/.sparc_tsim_config .
        - ./configure -f .sparc_tsim_config
        - make clean
        - make -j4
    rules:
       - if: '$CI_COMMIT_MESSAGE =~ /^\[(ALL|SPARC)\]/' # message starts with [ALL] or [SPARC]