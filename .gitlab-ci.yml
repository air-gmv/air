# First version for AIR main source code
# Executed in TASTE VM centralized in 192.19.13.167
# author: $(AIR_RUNNER_USER) @GMV 2020, edited by huca@GMV 2023

include:
    - 'gitlab-ci/.gitlab-ci-build.yml'
    - 'gitlab-ci/.gitlab-ci-examples.yml'
    - 'gitlab-ci/.gitlab-ci-validation.yml'
    - 'gitlab-ci/.gitlab-ci-report.yml'

stages:
    - prepare-build
    - examples
    - validation_tests
    - report

variables:
        GIT_SUBMODULE_STRATEGY : recursive
        GIT_STRATEGY : clone
        GIT_ASKPASS: /bin/echo
        GIT_HTTP_USERNAME: huca
        GIT_HTTP_PASSWORD: $CI_JOB_TOKEN

default:
    retry: 1
    before_script:
        - sleep $(($RANDOM % 2)).$RANDOM

        - export STATE_FOLDER=$HOME/state/$CI_COMMIT_SHA
        - export GIT_SSL_NO_VERIFY=1

        - git config --global credential.helper store
        - echo "https://huca:${CI_JOB_TOKEN}@$(AIR_GIT_REMOTE_HOSTNAME)" > ~/.git-credentials

        - if ! test -f git-clean.lock; 
            then 
                touch git-clean.lock; 
            fi

        - if ! $(grep -Fxq $CI_COMMIT_SHORT_SHA git-clean.lock); 
            then 
                git clean -ffdx && git submodule foreach --recursive git clean -ffdx && echo $CI_COMMIT_SHORT_SHA > git-clean.lock; 
                git submodule update --init --recursive; 
                git submodule sync --recursive; 
            fi
            
        - if ! test -d $STATE_FOLDER ; 
            then 
                (mkdir -p $STATE_FOLDER || true) && ./utils/gitlab-runner/check_central_server.bash ; 
            else 
                ./utils/gitlab-runner/check_central_server.bash ;
            fi;

        - while test -e /tmp/rsync-"$CI_COMMIT_SHORT_SHA".lock; 
            do sleep 1; 
            done;        

        - cd $STATE_FOLDER
        - cd air
        
        - export AIR=$STATE_FOLDER/air/
        - export PATH=$PATH:$AIR
        - export AIR_INSTALL=$AIR/install
        - export AIR_PMK=$AIR_INSTALL/pmk
        - export AIR_POS=$AIR_INSTALL/pos

        - export RTEMS410=/opt/rtems-4.10/bin
        - export PATH=$PATH:$RTEMS410
        - export RTEMS_MAKEFILE_PATH=$AIR_POS/rtems5/rtems5-install/sparc-rtems5/gr740
        - export PATH=$PATH:/opt/gcc-arm-9.2-2019.12-x86_64-arm-none-eabi/bin

        - export DISPLAY=:99
        - export PATH=/opt/rtems/5/bin:$PATH
        - export PATH=/opt/rtems-5.1-2019.07.25/bin:$PATH
        - export PATH=/opt/laysim-gr740:$PATH

        - export UTILS=$AIR/../utils/gitlab-runner

# .pre are jobs ran before any other job in the pipeline
# These jobs are used to check the state of VMs and to performn any specific VM action such as a cleanup.
# ARM and TASTE 1 are not allowed to fail since they are the only one with RVS license.
.pre_job-template : 
    stage : .pre
    variables : 
        GIT_STRATEGY : none # Prevents the cloning of the repository 
    allow_failure: true
    before_script : 
        - ''                # Prevents the before_script from running
    script : 
        -   if ! [[ -z $CLEANUP ]] ;
            then 
                rm -rf /home/gitlab-runner/state/* ;
            fi 

# ARM
ARM1_init : 
    extends : .pre_job-template
    allow_failure : false
    tags : 
        - ARM1

ARM2_init : 
    extends : .pre_job-template
    tags : 
        - ARM2

ARM3_init : 
    extends : .pre_job-template
    tags : 
        - ARM3

# TASTE
TASTE1_init :
    extends : .pre_job-template
    allow_failure : false
    tags : 
        - sparc-taste-debian1

TASTE2_init :
    extends : .pre_job-template
    tags : 
        - sparc-taste-debian2

TASTE3_init :
    extends : .pre_job-template
    tags : 
        - sparc-taste-debian3
    




