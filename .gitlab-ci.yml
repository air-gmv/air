# First version for AIR main source code
# Executed in TASTE VM centralized in 192.19.13.167
# author: $(AIR_RUNNER_USER) @GMV 2020

variables:
    GIT_CLEAN_FLAGS: none

default:
    before_script:
        - cd air
        - pwd
        - ls
        - export RTEMS410=/opt/rtems-4.10/bin
        - export AIR=`pwd`
        - export PATH=$PATH:$AIR
        - export PATH=$PATH:$RTEMS410
        - export GIT_SSL_NO_VERIFY=1
        - export AIR_INSTALL=$AIR/install
        - export AIR_PMK=$AIR_INSTALL/pmk
        - export AIR_POS=$AIR_INSTALL/pos
        - export RTEMS_MAKEFILE_PATH=$AIR_POS/rtems5/rtems5-install/sparc-rtems5/leon3
        - export PATH=$PATH:/opt/rtems-5.1-2019.07.25/bin
        - export PATH=$PATH:/home/taste/work/gcc-arm-9.2-2019.12-x86_64-arm-none-eabi/bin
        - export PATH=/opt/rtems-5-arm/bin:$PATH
        - git submodule sync --recursive
        - git submodule update --init --recursive


#Cronological order of jobs to be done
#To be divided in the future in multiple VMs
stages: 
    - sconfig-sparc
    - sbuild-sparc
    - sclean-build-sparc
    - test_hello_world_sparc
    - test_hm_sparc
    - test_00009_sparc
    - test_00010_sparc
    - test_00012_sparc
    - test_00021_sparc
    - test_00022_sparc
    - test_00023_sparc
    - test_00500_sparc
    - test_00510_sparc
    - test_00540_sparc
    - test_00560_sparc
    - test_00600_sparc
    - sconfig-arm
    - sclean-build-arm
    - sbuild-arm
    - test_hello_world_arm
    - test_00001_arm

#Build SPARC
config_sparc:
#    tags: 
#        - sparc
    stage: sconfig-sparc
    script:
        - cp $AIR/../utils/gitlab-runner/.sparc_config .
        - ./configure -f .sparc_config

build_sparc:
#    tags:
#        - sparc
    stage: sbuild-sparc
    script:
        - make clean # to be removed and used only on failure
        - make -j4

#clean_build_sparc:
#    tags: 
#        - sparc
#    stage: sclean-build-sparc
#    script:
#        - make clean
#        - make
#    when: on_failure


#Build for ARM
config_arm:
#    tags: 
#        - arm_qemu
    stage: sconfig-arm
    script:
        -  cp $AIR/../utils/gitlab-runner/.arm_config . 
        - ./configure -f .arm_config

build_arm:
#    tags: 
#        - arm_qemu
    stage: sbuild-arm
    script:
        - make clean # to be removed and used only on failure
        - make -j4

#clean_build_arm:
#    tags: 
#        - arm_qemu
#    stage: scleanbuild-arm
#    script:
#        - make clean
#        - make
#    when: on_failure


########################
#Example Tests for SPARC       #
########################
hello_sparc:
#    tags: 
#        - sparc
    stage: test_hello_world_sparc
    script:
        - cd $AIR/examples/hello_world
        - cp $AIR/../utils/gitlab-runner/* .
        - ./do_leon4_grmon.bash
        - cd $AIR
    environment:
        name: SPARC LEON4

        hello_sparc:
#    tags: 
#        - sparc
    stage: test_hm_sparc
    script:
        - cd $AIR/examples/hm
        - cp $AIR/../utils/gitlab-runner/* .
        - ./do_leon4_grmon.bash
        - cd $AIR
    environment:
        name: SPARC LEON4
########################
#Unit Tests for SPARC       #
########################


00009_sparc:
#    tags: 
#        - sparc
    stage: test_00009_sparc
    script:
        - cd $AIR/examples/validation/TEST-DEF-00009
        - cp $AIR/../utils/gitlab-runner/* .
        - ./do_leon4_grmon.bash
        - cd $AIR
    environment:
        name: SPARC LEON4

00010_sparc:
#    tags: 
#        - sparc
    stage: test_00010_sparc
    script:
        - cd $AIR/examples/validation/TEST-DEF-00010
        - cp $AIR/../utils/gitlab-runner/* .
        - ./do_leon4_grmon.bash
        - cd $AIR
    environment:
        name: SPARC LEON4

00012_sparc:
#    tags: 
#        - sparc
    stage: test_00012_sparc
    script:
        - cd $AIR/examples/validation/TEST-DEF-00012
        - cp $AIR/../utils/gitlab-runner/* .
        - ./do_leon4_grmon.bash
        - cd $AIR
    environment:
        name: SPARC LEON4



00021_sparc: 
#    tags: 
#        - sparc
    stage: test_00021_sparc
    script:
        - cd $AIR/examples/validation/TEST-DEF-00021
        - cp $AIR/../utils/gitlab-runner/* .
        - ./do_leon4_grmon.bash
        - cd $AIR
    environment:
        name: SPARC LEON4

00022_sparc: 
#    tags: 
#        - sparc
    stage: test_00022_sparc
    script:
        - cd $AIR/examples/validation/TEST-DEF-00022
        - cp $AIR/../utils/gitlab-runner/* .
        - ./do_leon4_grmon.bash
        - cd $AIR
    environment:
        name: SPARC LEON4

00023_sparc: 
#    tags: 
#        - sparc
    stage: test_00023_sparc
    script:
        - cd $AIR/examples/validation/TEST-DEF-00023
        - cp $AIR/../utils/gitlab-runner/* .
        - ./do_leon4_grmon.bash
        - cd $AIR
    environment:
        name: SPARC LEON4

00500_sparc: 
#    tags: 
#        - sparc
    stage: test_00500_sparc
    script:
        - cd $AIR/examples/validation/TEST-DEF-00500
        - cp $AIR/../utils/gitlab-runner/* .
        - ./do_leon4_grmon.bash
        - cd $AIR
    environment:
        name: SPARC LEON4

00510_sparc: 
#    tags: 
#        - sparc
    stage: test_00510_sparc
    script:
        - cd $AIR/examples/validation/TEST-DEF-00510
        - cp $AIR/../utils/gitlab-runner/* .
        - ./do_leon4_grmon.bash
        - cd $AIR
    environment:
        name: SPARC LEON4

00540_sparc: 
#    tags: 
#        - sparc
    stage: test_00540_sparc
    script:
        - cd $AIR/examples/validation/TEST-DEF-00540
        - cp $AIR/../utils/gitlab-runner/* .
        - ./do_leon4_grmon.bash
        - cd $AIR
    environment:
        name: SPARC LEON4

00560_sparc: 
#    tags: 
#        - sparc
    stage: test_00560_sparc
    script:
        - cd $AIR/examples/validation/TEST-DEF-00560
        - cp $AIR/../utils/gitlab-runner/* .
        - ./do_leon4_grmon.bash
        - cd $AIR
    environment:
        name: SPARC LEON4

00600_sparc: 
#    tags: 
#        - sparc
    stage: test_00600_sparc
    script:
        - cd $AIR/examples/validation/TEST-DEF-00600
        - cp $AIR/../utils/gitlab-runner/* .
        - ./do_leon4_grmon.bash
        - cd $AIR
    environment:
        name: SPARC LEON4

        
########################
#Tests for ARM         #
########################
#    tags: 
#        - arm_qemu

#hello_world_arm:
#    stage: test_hello_world_arm
#    script:
#        - cd $AIR/examples/hello_world
#        - configure
#        - make clean
#        - make
#        - cp $AIR/../utils/gitlab-runner/* .
#        - ls
#        - ./do_zynqz1_qemu.bash#
#        - ./testcheck.py
#        - cd $AIR
#    environment:
#        name: ARM ZYNQZ1


00001_arm:
    stage: test_00001_arm
    script:
        - cd $AIR/examples/arm_unit_tests/lionel
        - configure
        - make clean
        - make
        - cp $AIR/../utils/gitlab-runner/* .
        - ls
        - ./do_zynqz1_qemu.bash
        - ./testcheck.py
        - cd $AIR
    environment:
        name: ARM ZYNQZ1
