#
# Makefile : XKY Application Main Makefile
# Generated by XKY Configurator Tool v3.5
#
TARGET_BUILD=build
XKY_APP=../executable/XKYAPP.exe

# Makefile Include file
include $(XKY_ROOT)/Makefile.inc


SOURCE_FILES=\
usr_config.c\
usr_arch.c\
usr_hm.c\
usr_channels.c\
usr_schedules.c\
usr_partitions.c\
usr_sharedmemory.c\
usr_partitions_data.c

OBJECT_FILES=$(patsubst %.c,$(TARGET_BUILD)/%.o,\
             $(patsubst %.S,$(TARGET_BUILD)/%.o,$(SOURCE_FILES)))

TARGET_CPPFLAGS+=\
-DPMK_MAX_CORES=4\
-DPMK_SPARC_LEON4\
-fno-zero-initialized-in-bss\
-I./\
-I$(XKY_PMK)/core/include\
-I$(XKY_PMK)/bsp/sparc/leon3/include\
-I$(XKY_PMK)/arch/sparc/include

# All
.PHONY : all
all: $(XKY_APP)

# Create XKY application
$(XKY_APP): $(OBJECT_FILES)
	@(mkdir -p $(dir $(XKY_APP)))
	@($(CP) `$(TARGET_CC) -print-file-name=libgcc.a $(TARGET_CPPFLAGS)`  $(TARGET_BUILD)/libgcc.a)
	@($(CP) `$(TARGET_CC) -print-file-name=libc.a $(TARGET_CPPFLAGS)`  $(TARGET_BUILD)/libc.a)
	@($(CP) $(XKY_PMK)/pmk.a $(TARGET_BUILD)/pmk.a)
	# Link Everything
	$(TARGET_LD)\
		-nostdlib -nodefaultlibs -nostartfiles\
		-Tlinkcmds.ld\
		-Wl,--build-id=none\
		-Wl,--start-group\
		-L$(XKY_PMK)/\
		$(TARGET_BUILD)/pmk.a\
		$(TARGET_BUILD)/libc.a\
		$(TARGET_BUILD)/libgcc.a\
		$(TARGET_BUILD)/usr_config.o\
		$(TARGET_BUILD)/usr_arch.o\
		$(TARGET_BUILD)/usr_hm.o\
		$(TARGET_BUILD)/usr_channels.o\
		$(TARGET_BUILD)/usr_sharedmemory.o\
		$(TARGET_BUILD)/usr_schedules.o\
		$(TARGET_BUILD)/usr_partitions.o\
		$(TARGET_BUILD)/usr_partitions_data.o\
		-Wl,--end-group\
		-o $(XKY_APP)

# Assemble the partition ELFs into the configurations
.PHONY : usr_partitions_data.c
usr_partitions_data.c:
	@$(XKY_TOOLS)/partition_assembler\
		../master/p0.exe 0x41000000 0x00100000\
		../p1/p1.exe 0x41000000 0x00100000\
		../p2/p2.exe 0x41000000 0x00100000\
		../p3/p3.exe 0x41000000 0x00100000

# Clean
.PHONY : clean
clean:
	@($(RM) $(TARGET_BUILD))
	@($(RM) $(dir $(XKY_APP)))

# Distclean
.PHONY : distclean
distclean: clean
	@($(RM) usr_partitions_data.c)

